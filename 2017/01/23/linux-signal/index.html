
<!DOCTYPE html>
<html lang="ja">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="harasou.jp">
    <title>Linux シグナルの基礎 - harasou.jp</title>
    <meta name="author" content="harasou">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/ae9a272994f212bdbddfa0f4367b0f3d?s=640"/>
    
    
        <meta property="og:image" content="https://harasou.jp/2017/01/23/linux-signal/linux-programming-interface.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://harasou.jp/2017/01/23/linux-signal/linux-programming-interface.png" />
    
    
    
    <meta name="description" content="TLPI (The Linux Programming Interface) 再々。
TLPI の輪読の際に @matsumotory よりシグナルセットあたりをまとめるようにと指令が出たので、拙遅な感じでまとめました。">
<meta property="og:type" content="blog">
<meta property="og:title" content="Linux シグナルの基礎">
<meta property="og:url" content="https://harasou.jp/2017/01/23/linux-signal/index.html">
<meta property="og:site_name" content="harasou.jp">
<meta property="og:description" content="TLPI (The Linux Programming Interface) 再々。
TLPI の輪読の際に @matsumotory よりシグナルセットあたりをまとめるようにと指令が出たので、拙遅な感じでまとめました。">
<meta property="og:image" content="https://harasou.jp/2017/01/23/linux-signal/signal.png">
<meta property="og:image" content="https://harasou.jp/2017/01/23/linux-signal/signal-life.png">
<meta property="og:updated_time" content="2017-01-24T14:36:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux シグナルの基礎">
<meta name="twitter:description" content="TLPI (The Linux Programming Interface) 再々。
TLPI の輪読の際に @matsumotory よりシグナルセットあたりをまとめるようにと指令が出たので、拙遅な感じでまとめました。">
<meta name="twitter:image" content="https://harasou.jp/2017/01/23/linux-signal/signal.png">
<meta name="twitter:creator" content="@harasou5">
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-nuvue6sithwirecbhvw3dkaobiojqvtadsnhguwi7k04xklybw5djl1smadp.min.css">
    <link rel="stylesheet" href="/assets/style.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-62541096-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">harasou.jp</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/ae9a272994f212bdbddfa0f4367b0f3d?s=90"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/ae9a272994f212bdbddfa0f4367b0f3d?s=110"/>
            </a>
            <span class="sidebar-profile-name">harasou</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">ホーム</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">カテゴリー</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">タグ</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">アーカイブ</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">プロフィール</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/harasou" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Linux シグナルの基礎
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" datetime="2017-01-23T02:24:22+09:00">
	
		    2017/01/23
    	
    </time>
    
</div>

</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>TLPI (The Linux Programming Interface) 再々。</p>
<p>TLPI の輪読の際に @matsumotory よりシグナルセットあたりをまとめるようにと指令が出たので、拙遅な感じでまとめました。</p>
<a id="more"></a>
<h1 id="table-of-contents">目次</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナルとは"><span class="toc-text">シグナルとは</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#シグナルの主な特徴"><span class="toc-text">シグナルの主な特徴</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナルの種類"><span class="toc-text">シグナルの種類</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナルの生成"><span class="toc-text">シグナルの生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナルの配送"><span class="toc-text">シグナルの配送</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#シグナルセット"><span class="toc-text">シグナルセット</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナルの保留"><span class="toc-text">シグナルの保留</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#シグナルマスク"><span class="toc-text">シグナルマスク</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ブロック中のシグナル"><span class="toc-text">ブロック中のシグナル</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#シグナル処理時のカーネルの動作"><span class="toc-text">シグナル処理時のカーネルの動作</span></a></li></ol>
<h2 id="シグナルとは"><a href="/2017/01/23/linux-signal/#シグナルとは" class="headerlink" title="シグナルとは"></a>シグナルとは</h2><p>プロセス間通信の一種。「プロセスにシグナルを送信すると、そのプロセスの正常処理に割り込んで、シグナル固有の処理(シグナルハンドラ) が実行される」プロセス側では、シグナルを受信した際の動作(シグナルハンドラ) を設定することや、シグナルをブロックすることも可能。</p>
<p><img src="/2017/01/23/linux-signal/signal.png" alt=""></p>
<p>コンソールで、プロセスを終了させるために <code>kill -9 &lt;PID&gt;</code> とか <code>Ctrl+C</code> とかした際にも、対象プロセスにシグナルが送信されている。</p>
<p>ちなみに、PID「1」の init や systemd に <code>kill -9 1</code> しても何も起らない。(そういえば昔、oom-killer に init を殺された覚えがあるな。勘違いだったか…)</p>
<h3 id="シグナルの主な特徴"><a href="/2017/01/23/linux-signal/#シグナルの主な特徴" class="headerlink" title="シグナルの主な特徴"></a>シグナルの主な特徴</h3><ul>
<li>シグナルの状態<ul>
<li>シグナルを送ることを「生成」といい、そのシグナルが処理されることを「配送」という。また、生成から配送まで間の状態を「保留」という</li>
</ul>
</li>
<li>シグナルの生成<ul>
<li>シグナルは、別プロセスや自身からも送信可能だが主にカーネルから送られることが多い</li>
<li>シグナルは、プロセスだけでなく特定スレッドに対しても送信可能</li>
</ul>
</li>
<li>シグナルの配送<ul>
<li>シグナルの種類によって、受信した際の標準の動作が決められている(SIGINTはプロセス終了、など)</li>
<li>シグナルを受信するプロセスは、シグナル受信時の動作を変更できる(シグナルハンドラの登録)</li>
</ul>
</li>
<li>シグナルの保留<ul>
<li>シグナルを受信するプロセスは、特定のシグナルをブロック・アンブロックすることができる(ブロック中にきたシグナルはアンブロック時に配送される)</li>
</ul>
</li>
</ul>
<h2 id="シグナルの種類"><a href="/2017/01/23/linux-signal/#シグナルの種類" class="headerlink" title="シグナルの種類"></a>シグナルの種類</h2><p>シグナルには、古くからある「標準シグナル」と機能が追加された「リアルタイムシグナル」の 2種類がある。 シグナルには一意の整数(シグナル番号) が割り当てられていて、標準シグナルの場合は 1 から 32(NSIG) となっている。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[/usr/include/asm/signal.h]</div><div class="line"></div><div class="line"> 12 /* Here we must cater to libcs that poke about in kernel headers.  */</div><div class="line"> 13</div><div class="line"> 14 #define NSIG            32</div><div class="line"> 15 typedef unsigned long sigset_t;</div><div class="line"> 16</div><div class="line"> 17 #endif /* __ASSEMBLY__ */</div><div class="line"> 18</div><div class="line"> 19</div><div class="line"> 20 #define SIGHUP           1</div><div class="line"> 21 #define SIGINT           2</div><div class="line"> 22 #define SIGQUIT          3</div><div class="line"> 23 #define SIGILL           4</div><div class="line"> 24 #define SIGTRAP          5</div><div class="line"> 25 #define SIGABRT          6</div><div class="line"> 26 #define SIGIOT           6</div><div class="line"> 27 #define SIGBUS           7</div><div class="line"> 28 #define SIGFPE           8</div><div class="line"> 29 #define SIGKILL          9</div><div class="line"> 30 #define SIGUSR1         10</div><div class="line"> 31 #define SIGSEGV         11</div><div class="line"> 32 #define SIGUSR2         12</div><div class="line"> 33 #define SIGPIPE         13</div><div class="line"> 34 #define SIGALRM         14</div><div class="line"> 35 #define SIGTERM         15</div><div class="line"> 36 #define SIGSTKFLT       16</div><div class="line"> 37 #define SIGCHLD         17</div><div class="line"> 38 #define SIGCONT         18</div><div class="line"> 39 #define SIGSTOP         19</div><div class="line"> 40 #define SIGTSTP         20</div><div class="line"> 41 #define SIGTTIN         21</div><div class="line"> 42 #define SIGTTOU         22</div><div class="line"> 43 #define SIGURG          23</div><div class="line"> 44 #define SIGXCPU         24</div><div class="line"> 45 #define SIGXFSZ         25</div><div class="line"> 46 #define SIGVTALRM       26</div><div class="line"> 47 #define SIGPROF         27</div><div class="line"> 48 #define SIGWINCH        28</div><div class="line"> 49 #define SIGIO           29</div><div class="line"> 50 #define SIGPOLL         SIGIO</div><div class="line"> 51 /*</div><div class="line"> 52 #define SIGLOST         29</div><div class="line"> 53 */</div><div class="line"> 54 #define SIGPWR          30</div><div class="line"> 55 #define SIGSYS          31</div><div class="line"> 56 #define SIGUNUSED       31</div><div class="line"> 57</div><div class="line"> 58 /* These should not be considered constants from userland.  */</div><div class="line"> 59 #define SIGRTMIN        32</div><div class="line"> 60 #define SIGRTMAX        _NSIG</div></pre></td></tr></table></figure>
<p>標準シグナルによってプロセスに伝えれらる情報は「シグナル番号」のみ。いつ、どこから何回受信したかと言った情報は伝えられない。 リアルタイムシグナルでは、こういった情報を伝えることができるようになっている。なお、リアルタイムシグナルには、標準シグナルのようなシグナル番号に対応すに名前(SIGHUP など)は定義されていない。<br><div class="alert info"><p>@n_soda さんにコメントいただいたので補足<br><code>プロセスに伝えれらる情報は「シグナル番号」のみ</code><br>上記の様に記載していますが、sigaction() に SA_SIGINFO フラグを指定することで、handler 実行時にシグナルを生成した pid, uid, フォルト時のアドレスなどを含む、siginfo_t を受け取ることは可能です。</p>
</div></p>
<h2 id="シグナルの生成"><a href="/2017/01/23/linux-signal/#シグナルの生成" class="headerlink" title="シグナルの生成"></a>シグナルの生成</h2><p>プロセスからシグルナルを送信する場合は、以下のようなシステムコールや glibc の関数を用いる。</p>
<table>
<thead>
<tr>
<th style="text-align:left">システムコール・関数</th>
<th style="text-align:left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">kill()</td>
<td style="text-align:left">プロセスにシグナルを送信</td>
</tr>
<tr>
<td style="text-align:left">pthread_kill()</td>
<td style="text-align:left">スレッドにシグナルを送信</td>
</tr>
<tr>
<td style="text-align:left">raise()</td>
<td style="text-align:left">自身にシグナルを送信</td>
</tr>
<tr>
<td style="text-align:left">killpg()</td>
<td style="text-align:left">プロセスグループにシグナルを送信</td>
</tr>
</tbody>
</table>
<p>また、ハードウェアや端末契機でもシグナルは送られてくる。</p>
<ul>
<li>ハードウェア例外<ul>
<li><code>SIGFPE</code> : 0 除算</li>
<li><code>SIGSEGV</code> : メモリアクセス違反</li>
</ul>
</li>
<li>端末へキー入力<ul>
<li><code>SIGINT</code> : Ctrl+C が入力された</li>
<li><code>SIGQUIT</code> : Ctrl+\ が入力された</li>
</ul>
</li>
<li>ソフトウェアイベント<ul>
<li><code>SIGCHLD</code> : 子プロセスが終了した</li>
<li><code>SIGXCPU</code> : CPU の利用上限に達した (ハードリミットでは<code>SIGKILL</code>)</li>
<li><code>SIGIO</code> : fd からデータが読み取れる状態になった</li>
</ul>
</li>
</ul>
<h2 id="シグナルの配送"><a href="/2017/01/23/linux-signal/#シグナルの配送" class="headerlink" title="シグナルの配送"></a>シグナルの配送</h2><p>シグナルが配送されると、プロセスの通常処理に割り込んで、シグナルハンドラが実行される。</p>
<p>シグナル種類ごとにデフォルトの動作が決められており、個別にシグナルハンドラを登録していなければ、そのデフォルトの動作がカーネルにより実行される。デフォルトの動作は以下の５つ。</p>
<ol>
<li>プロセスを終了する</li>
<li>コアを出力し、プロセスを終了する</li>
<li>シグナルを無視する</li>
<li>処理を一時停止する</li>
<li>処理を再開する</li>
</ol>
<p>シグナルハンドラは、以下どちらかの関数を使用してシグナル番号ごとに登録できる。signal より sigaction のほうが、機能や移植性から見ても有用なので、利用を推奨されているらしい。</p>
<ul>
<li><p>signal()</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> ( *signal(<span class="keyword">int</span> sig, <span class="keyword">void</span> (*handler)(<span class="keyword">int</span>)) ) (<span class="keyword">int</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>sigaction()</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span><span class="params">(<span class="keyword">int</span> sig, <span class="keyword">const</span> <span class="keyword">struct</span> sigaction *act, <span class="keyword">struct</span> sigaction *oldact)</span></span>;</div></pre></td></tr></table></figure>
<p>  引数 act の型である sigaction 構造体は、以下のようになっている。</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> sigaction &#123;</div><div class="line">    <span class="keyword">void</span> (*sa_handler)(<span class="keyword">int</span>);</div><div class="line">    <span class="keyword">sigset_t</span> sa_mask;</div><div class="line">    <span class="keyword">int</span> sa_flags;</div><div class="line">    <span class="keyword">void</span> (*sa_restorer)(<span class="keyword">void</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  1 つ目のメンバである<code>sa_handler</code>は signal() の引数<code>handler</code>と同様にシグナルハンドラを表す。<br>  2 つ目のメンバである<code>sa_mask</code>はハンドラ実行中にブロックしたいグナルを指定する。ブロックしたいシグナルが複数ある場合もあるので、複数のシグナルを表すことができるシグナルセット(sigset_t) が利用されている。</p>
</li>
</ul>
<h3 id="シグナルセット"><a href="/2017/01/23/linux-signal/#シグナルセット" class="headerlink" title="シグナルセット"></a>シグナルセット</h3><p>シグナルセットは、複数のシグナルをまとめて表現するもの。どのシグナルが選択されているかを表すだけなので、Linux では以下のような整数型で実装されており、各ビットの位置がシグナル番号に対応する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[/usr/include/asm/signal.h]</div><div class="line"></div><div class="line">typedef unsigned long sigset_t;</div></pre></td></tr></table></figure>
<p>プロセスがどのシグナルをブロックしているかは /proc/PID/status を見るとわかる(下記は 64bit 環境)。 bash を例にすると、<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># grep ^SigBlk /proc/$$/status</div><div class="line">SigBlk: 0000000000010000</div></pre></td></tr></table></figure></p>
<p>SigBlk の値がブロックしているシグナルを表していて、これは16進表記になっているので、2進表記にすると以下のようになる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># ruby -e &apos;printf(&quot;%064b\n&quot;,0x0000000000010000)&apos;</div><div class="line">0000000000000000000000000000000000000000000000010000000000000000</div></pre></td></tr></table></figure>
<p>つまり、17bit 目にビットが立っているので、上に記載した「<a href="/2017/01/23/linux-signal/#シグナルの種類">シグナルの種類</a>」を見ると、シグナル番号 17 つまり、SIGCHLD のみブロックしていることがわかる。<br><div class="alert warning"><p>記事公開時、SigBlk を紹介するところを誤って SigIgn の例を記載していたため、修正しました。</p>
</div></p>
<p>ただ、Linux の実装がビットマスク使用しているだけなので、シグナルマスクを操作する場合は、必ず以下の関数を用いる必要がある。</p>
<table>
<thead>
<tr>
<th style="text-align:left">関数</th>
<th style="text-align:left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">sigemptyset</td>
<td style="text-align:left">すべてシグナルが選択されていない状態に初期化する</td>
</tr>
<tr>
<td style="text-align:left">sigfillset</td>
<td style="text-align:left">すべてシグナルが選択されている状態に初期化する</td>
</tr>
<tr>
<td style="text-align:left">sigaddset</td>
<td style="text-align:left">シグナルセットに一つのシグナルを追加する</td>
</tr>
<tr>
<td style="text-align:left">sigdelset</td>
<td style="text-align:left">シグナルセットから一つのシグナルを削除する</td>
</tr>
<tr>
<td style="text-align:left">sigismember</td>
<td style="text-align:left">シグナルセットに特定のシグナルが含まれているか調べる</td>
</tr>
<tr>
<td style="text-align:left">sigandset</td>
<td style="text-align:left">シグナルセットに指定した sigset_t とAND した結果を設定する</td>
</tr>
<tr>
<td style="text-align:left">sigorset</td>
<td style="text-align:left">シグナルセットに指定した sigset_t とOR した結果を設定する</td>
</tr>
<tr>
<td style="text-align:left">sigisemptyset</td>
<td style="text-align:left">シグナルセットが空かどうかしらべる</td>
</tr>
</tbody>
</table>
<h2 id="シグナルの保留"><a href="/2017/01/23/linux-signal/#シグナルの保留" class="headerlink" title="シグナルの保留"></a>シグナルの保留</h2><p>シグナルが「生成」され、該当のプロセスが次に実行されたタイミングで、シグナルは「配送」される。この生成から配送までの間の状態を「保留」という。</p>
<p><img src="/2017/01/23/linux-signal/signal-life.png" alt=""></p>
<p>保留の状態は、スケジュール待ちの場合だけでなく、プロセス自身でシグナルをブロックすることでも発生する。</p>
<p>さきほど説明した sigaction() では、シグナルセットを使用してシグナルのブロックを指示することができた。ただ、これは、シグナルハンドラ実行中のみブロックされており、ハンドラが終了すると自動的に解除（アンブロック）される。</p>
<p>そのため、 明示的にブロック・アンブロックしたい場合は、sigprocmask(), pthread_sigmask() を使用する。</p>
<h3 id="シグナルマスク"><a href="/2017/01/23/linux-signal/#シグナルマスク" class="headerlink" title="シグナルマスク"></a>シグナルマスク</h3><p>ブロックしているシグナルは「シグナルマスク」というプロセス（正しくはスレッド）の属性で管理されており、以下のようなタイミングで操作される。</p>
<ul>
<li>シグナルが配送された際、下記シグナルをシグナルマスクに追加し、シグナルハンドラが完了するとシグナルマスクから自動的に削除する<ul>
<li>受診した該当のシグナル（sigaction で変更可能）</li>
<li>sigaction で指定したブロックしたいグナルセットのシグナル</li>
</ul>
</li>
<li>sigprocmask(), pthread_sigmask() が実行されたタイミング<ul>
<li>引数に <code>SIG_BLOCK</code> が指定されると追加、<code>SIG_UNBLOCK</code> が指定されると削除される</li>
</ul>
</li>
</ul>
<h3 id="ブロック中のシグナル"><a href="/2017/01/23/linux-signal/#ブロック中のシグナル" class="headerlink" title="ブロック中のシグナル"></a>ブロック中のシグナル</h3><p>ブロック中のシグナルが生成されると、カーネルはシグナルを保留シグナルに追加し、該当のシグナルがアンブロックされるまで配送しない。また、ブロック中に同じシグナル番号のシグナルが複数回生成されても、アンブロック時には一度しか配送されない。</p>
<p>保留シグナルは、ブロックシグナル（SigBlk）と同様に /proc/PID/status で確認できる。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># sleep 10 &amp;</div><div class="line">[1] 21577</div><div class="line">#</div><div class="line"># kill -STOP 21577</div><div class="line"># kill -USR1 21577</div><div class="line"># grep ^ShdPnd /proc/21577/status</div><div class="line">SigPnd: 0000000000000200</div><div class="line">#</div><div class="line"># ruby -e &apos;printf(&quot;%064b\n&quot;,0x0000000000000200)&apos;</div><div class="line">0000000000000000000000000000000000000000000000000000001000000000</div></pre></td></tr></table></figure></p>
<p>sleep コマンドを STOP し、SIGUSR1 を送っている。STOP しているのでシグナル(SIGUSR1)が配送されず、保留状態となっている。</p>
<p>なお、SIGKILL、SIGSTOP をブロックしようとしても無視され、エラーにもならない。</p>
<h2 id="シグナル処理時のカーネルの動作"><a href="/2017/01/23/linux-signal/#シグナル処理時のカーネルの動作" class="headerlink" title="シグナル処理時のカーネルの動作"></a>シグナル処理時のカーネルの動作</h2><p>(本当は、ここの内容をメインにしたかったが、概要を書いただけで力尽きたので、次回書く。)</p>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">タグ</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/linux/">linux</a> <a class="tag tag--primary tag--small t-link" href="/tags/signal/">signal</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">前</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/29/linux-acl/" data-tooltip="Linux ACL の基礎">
                
                    <span class="hide-xs hide-sm text-small icon-mr">次</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs pocket-btn-icon">
            <a class="post-action-btn btn btn--default pocket-btn-icon-link" target="new" href="http://getpocket.com/edit?url=https%3A%2F%2Fharasou.jp%2F2017%2F01%2F23%2Flinux-signal%2F&title=Linux シグナルの基礎">
                 <i class="icon-pocket"></i>
            </a>
        </li>
        <li class="post-action hide-xs hatebu-btn-icon">
            <a class="post-action-btn btn btn--default hatebu-btn-icon-link" target="new" href="http://b.hatena.ne.jp/add?mode=confirm&url=https://harasou.jp/2017/01/23/linux-signal/">
                 <i class="icon-hatebu hatena-bookmark-button"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/share?text=Linux%20%E3%82%B7%E3%82%B0%E3%83%8A%E3%83%AB%E3%81%AE%E5%9F%BA%E7%A4%8E&via=harasou5&url=https%3A%2F%2Fharasou.jp%2F2017%2F01%2F23%2Flinux-signal%2F">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
        <li class="post-action">
            <a class="post-action-btn btn btn--default" href="#table-of-contents">
                <i class="fa fa-list"></i>
            </a>
        </li>
        
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 harasou. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">前</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/29/linux-acl/" data-tooltip="Linux ACL の基礎">
                
                    <span class="hide-xs hide-sm text-small icon-mr">次</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs pocket-btn-icon">
            <a class="post-action-btn btn btn--default pocket-btn-icon-link" target="new" href="http://getpocket.com/edit?url=https%3A%2F%2Fharasou.jp%2F2017%2F01%2F23%2Flinux-signal%2F&title=Linux シグナルの基礎">
                 <i class="icon-pocket"></i>
            </a>
        </li>
        <li class="post-action hide-xs hatebu-btn-icon">
            <a class="post-action-btn btn btn--default hatebu-btn-icon-link" target="new" href="http://b.hatena.ne.jp/add?mode=confirm&url=https://harasou.jp/2017/01/23/linux-signal/">
                 <i class="icon-hatebu hatena-bookmark-button"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/share?text=Linux%20%E3%82%B7%E3%82%B0%E3%83%8A%E3%83%AB%E3%81%AE%E5%9F%BA%E7%A4%8E&via=harasou5&url=https%3A%2F%2Fharasou.jp%2F2017%2F01%2F23%2Flinux-signal%2F">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
        <li class="post-action">
            <a class="post-action-btn btn btn--default" href="#table-of-contents">
                <i class="fa fa-list"></i>
            </a>
        </li>
        
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-google-plus"></i><span class="">Google Plusで共有</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-facebook-official"></i><span>Facebookで共有</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://harasou.jp/2017/01/23/linux-signal/">
                <i class="fa fa-twitter"></i><span>Twitterで共有</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/ae9a272994f212bdbddfa0f4367b0f3d?s=110"/>
        
            <h4 id="about-card-name">harasou</h4>
        
            <h5 id="about-card-bio"><p>めくじらを立てない</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Infra Engineer</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Fukuoka Japan
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script-i4qo6jx6jji9fg0dftpya6ivemizsbow4fhow76d8dwpm7m1wbvi378ssumx.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'https://harasou.jp/2017/01/23/linux-signal/';
                 
                    this.page.identifier = '2017/01/23/linux-signal/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'harasougithubio';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



</html>
